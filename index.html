<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéâ Mini-Jeux d'Anniversaire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 600px;
            width: 100%;
        }

        .bg-gradient-purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .bg-gradient-blue { background: linear-gradient(135deg, #667eea 0%, #f093fb 100%); }
        .bg-gradient-orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .bg-gradient-yellow { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

        .icon-box {
            display: inline-block;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            color: white;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .info-box {
            background: #f0f4ff;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: center;
        }

        .timer {
            font-size: 48px;
            font-weight: bold;
            color: #f5576c;
            margin-bottom: 20px;
        }

        .game-card {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 30px;
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .game-card h3 {
            font-size: 24px;
            color: #333;
            margin-bottom: 15px;
        }

        .game-card p {
            font-size: 18px;
            color: #555;
        }

        .player-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-box {
            padding: 20px;
            border-radius: 12px;
            background: #f5f5f5;
        }

        .player-box.finished {
            background: #d4edda;
        }

        .player-box p {
            margin: 5px 0;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 12px;
            background: #f5f5f5;
        }

        .score-item.gold {
            background: #ffeaa7;
            border: 2px solid #fdcb6e;
        }

        .score-item.silver {
            background: #dfe6e9;
            border: 2px solid #b2bec3;
        }

        .score-item.bronze {
            background: #fab1a0;
            border: 2px solid #e17055;
        }

        .rank {
            font-size: 24px;
            font-weight: bold;
            margin-right: 15px;
        }

        .trophy {
            font-size: 64px;
            text-align: center;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .scores-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gradient-purple">
    <!-- √âcran de connexion -->
    <div id="loginScreen" class="container">
        <div style="text-align: center;">
            <div class="icon-box">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <h1>üéâ Mini-Jeux d'Anniversaire</h1>
            <p class="subtitle">Entre ton nom pour commencer !</p>
        </div>
        
        <div id="errorContainer"></div>
        
        <input type="text" id="playerNameInput" placeholder="Ton nom..." />
        <button class="btn-primary" id="loginBtn">
            Rejoindre la f√™te !
        </button>
    </div>

    <!-- √âcran d'attente -->
    <div id="waitingScreen" class="container hidden">
        <h1 id="welcomeText">Bienvenue !</h1>
        <p class="subtitle">Pr√™t pour les mini-jeux ?</p>
        
        <div class="info-box">
            <p><strong id="waitingCount">0</strong> joueur(s) en attente</p>
        </div>
        
        <button class="btn-success" id="startGameBtn">
            ‚ñ∂Ô∏è Lancer un mini-jeu !
        </button>
    </div>

    <!-- √âcran de jeu -->
    <div id="playingScreen" class="container hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div class="timer" id="timer">30s</div>
            <div style="text-align: right;">
                <p style="color: #666; margin-bottom: 5px;">Adversaire</p>
                <p style="font-weight: bold; font-size: 18px;" id="opponentName">-</p>
            </div>
        </div>

        <div class="game-card">
            <h3 id="gameName">D√©fi</h3>
            <p id="gameDescription">Description du d√©fi</p>
        </div>

        <div class="player-grid">
            <div class="player-box" id="playerBox">
                <p style="color: #666; font-size: 14px;">Toi</p>
                <p style="font-weight: bold;" id="playerNameDisplay">-</p>
            </div>
            <div class="player-box" id="opponentBox">
                <p style="color: #666; font-size: 14px;">Adversaire</p>
                <p style="font-weight: bold;" id="opponentNameDisplay">-</p>
            </div>
        </div>

        <button class="btn-success" id="finishBtn">
            ‚úì Fini !
        </button>
    </div>

    <!-- √âcran de classement -->
    <div id="leaderboardScreen" class="container hidden">
        <div class="trophy">üèÜ</div>
        <h1>Classement</h1>
        <p class="subtitle">Les meilleurs temps !</p>
        
        <div class="scores-container" id="scoresList"></div>
        
        <button class="btn-primary" id="replayBtn" style="margin-top: 20px;">
            üîÑ Rejouer !
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // CONFIGURATION SUPABASE - REMPLACE PAR TES CL√âS
        const SUPABASE_URL = 'https://pmbdfnxkzklecrnhdcol.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBtYmRmbnhremtsZWNybmhkY29sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NzI0MTYsImV4cCI6MjA4NDE0ODQxNn0.9ix9L-k7PCeEQDy9qhf2Uz27VqQb3cF2KQ9V1taVhqw';
        
        let supabaseClient;
        
        try {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (error) {
            console.error('Erreur initialisation Supabase:', error);
            showError('Erreur de connexion √† la base de donn√©es. V√©rifie tes cl√©s Supabase !');
        }

        const MINIGAMES = [
            { id: 1, name: "Chat", description: "Trouve Mozza le plus vite possible !", duration: 300 },
            { id: 2, name: "Emoji", description: "Trouve un des emojis plac√©s dans la maison !", duration: 300 },
            { id: 3, name: "Sport", description: "Monte et descends 10 fois d'affil√©e l'escalier !", duration: 300 },
            { id: 4, name: "Sous-sol", description: "Un ballon est cach√© dans le sous-sol ! Saurez-vous le retrouver ?", duration: 300 },
            { id: 5, name: "Vol", description: "Vol les chaussures de ton adversaire sans qu'il ne le remarque !", duration: 300 },
            { id: 6, name: "Loup", description: "Tu deviens le loup ! Touche quelqu'un le plus vite possible !", duration: 300 },
            { id: 7, name: "Yassine_officiel", description: "Trouve la vid√©o la plus courte de Yassine et mets-la !", duration: 300 }
        ];

        let playerId = null;
        let playerName = '';
        let currentPair = null;
        let currentGame = null;
        let timerInterval = null;
        let playerFinished = false;
        let opponentFinished = false;
        let gameChannel = null;

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        function showScreen(screenId) {
            document.querySelectorAll('.container').forEach(s => s.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        async function handleLogin() {
            playerName = document.getElementById('playerNameInput').value.trim();
            if (!playerName) {
                showError('Entre ton nom !');
                return;
            }

            clearError();
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Connexion...';

            try {
                const { data, error } = await supabaseClient
                    .from('players')
                    .insert([{ name: playerName, status: 'waiting' }])
                    .select()
                    .single();

                if (error) throw error;

                playerId = data.id;

// ===== DETECTION ADMIN =====
if (data.is_admin) {
    showScreen('adminScreen');       // Affiche l'√©cran admin
    loadAdminPlayerList();           // Charge la liste des joueurs en attente
    updateAdminWaitingCount();       // Met √† jour le compteur
    return;                          // On sort de handleLogin pour ne pas montrer l'√©cran joueur
}
// ============================

             if (data.is_admin) {
    showScreen('adminScreen');       // Affiche l'√©cran admin
    loadAdminPlayerList();           // Charge la liste des joueurs
    updateAdminWaitingCount();       // Met √† jour le compteur
} else {
    showScreen('waitingScreen');     // √âcran joueur normal
    updateWaitingCount();            // Compteur joueurs en attente
    subscribeToChanges();            // √âcoute les scores / changements
    document.getElementById('startGameBtn').style.display = 'none'; // <-- cache le bouton
}


            } catch (error) {
                console.error('Erreur:', error);
                showError('Erreur de connexion. V√©rifie ta configuration Supabase !');
                btn.disabled = false;
                btn.textContent = 'Rejoindre la f√™te !';
            }
        }

        async function updateWaitingCount() {
            try {
                const { count } = await supabaseClient
                    .from('players')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'waiting');
                document.getElementById('waitingCount').textContent = count || 0;
            } catch (error) {
                console.error('Erreur comptage:', error);
            }
        }

        async function startGame() {
            const btn = document.getElementById('startGameBtn');
            btn.disabled = true;
            btn.textContent = 'Lancement...';

            try {
                const { data: availablePlayers } = await supabaseClient
                    .from('players')
                    .select('*')
                    .eq('status', 'waiting')
                    .neq('id', playerId)
                    .limit(1);

                let opponentId, opponentName;

                if (availablePlayers && availablePlayers.length > 0) {
                    opponentId = availablePlayers[0].id;
                    opponentName = availablePlayers[0].name;
                    await supabaseClient.from('players')
                        .update({ status: 'paired' })
                        .in('id', [playerId, opponentId]);
                } else {
                    const { data: bot } = await supabaseClient
                        .from('players')
                        .insert([{ name: 'Bot ü§ñ', status: 'paired' }])
                        .select()
                        .single();
                    opponentId = bot.id;
                    opponentName = bot.name;
                    await supabaseClient.from('players')
                        .update({ status: 'paired' })
                        .eq('id', playerId);
                }

                currentGame = MINIGAMES[Math.floor(Math.random() * MINIGAMES.length)];

                const { data: pair } = await supabaseClient
                    .from('pairs')
                    .insert([{
                        player1_id: playerId,
                        player2_id: opponentId,
                        game_id: currentGame.id,
                        status: 'active'
                    }])
                    .select()
                    .single();

                currentPair = { ...pair, opponent_name: opponentName };

                document.getElementById('gameName').textContent = currentGame.name;
                document.getElementById('gameDescription').textContent = currentGame.description;
                document.getElementById('opponentName').textContent = opponentName;
                document.getElementById('playerNameDisplay').textContent = playerName;
                document.getElementById('opponentNameDisplay').textContent = opponentName;

                showScreen('playingScreen');
                startTimer(currentGame.duration);

                if (opponentName.includes('Bot')) {
                    setTimeout(async () => {
                        await supabaseClient.from('scores').insert([{
                            player_id: opponentId,
                            pair_id: pair.id,
                            player_name: opponentName,
                            game_name: currentGame.name,
                            time_seconds: Math.floor(Math.random() * 10) + 15
                        }]);
                    }, Math.random() * 15000 + 8000);
                }
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors du lancement. R√©essaye !');
                btn.disabled = false;
                btn.textContent = '‚ñ∂Ô∏è Lancer un mini-jeu !';
            }
        }

        function startTimer(duration) {
            let timeLeft = duration;
            document.getElementById('timer').textContent = `${timeLeft}s`;

            if (timerInterval) clearInterval(timerInterval);

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = `${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        async function handleFinish() {
            if (playerFinished) return;
            playerFinished = true;

            const btn = document.getElementById('finishBtn');
            btn.disabled = true;
            btn.textContent = '‚úì D√©fi termin√© !';
            document.getElementById('playerBox').classList.add('finished');

            const timeLeft = parseInt(document.getElementById('timer').textContent);
            const finalTime = currentGame.duration - timeLeft;

            try {
                await supabaseClient.from('scores').insert([{
                    player_id: playerId,
                    pair_id: currentPair.id,
                    player_name: playerName,
                    game_name: currentGame.name,
                    time_seconds: finalTime
                }]);

                await supabaseClient.from('players')
                    .update({ status: 'finished' })
                    .eq('id', playerId);
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function subscribeToChanges() {
            if (gameChannel) {
                supabaseClient.removeChannel(gameChannel);
            }

            gameChannel = supabaseClient
                .channel('game-updates-' + Date.now())
                .on('postgres_changes', 
                    { event: 'INSERT', schema: 'public', table: 'scores' },
                    async (payload) => {
                        if (currentPair && payload.new.pair_id === currentPair.id) {
                            if (payload.new.player_id !== playerId) {
                                opponentFinished = true;
                                document.getElementById('opponentBox').classList.add('finished');
                            }

                            const { data: scores } = await supabaseClient
                                .from('scores')
                                .select('*')
                                .eq('pair_id', currentPair.id);

                            if (scores && scores.length === 2) {
                                clearInterval(timerInterval);
                                setTimeout(() => loadLeaderboard(), 2000);
                            }
                        }
                    }
                )
                .subscribe();
        }

        async function loadLeaderboard() {
            try {
                const { data } = await supabaseClient
                    .from('scores')
                    .select('*')
                    .order('time_seconds', { ascending: true });

                const scoresList = document.getElementById('scoresList');
                scoresList.innerHTML = '';

                if (!data || data.length === 0) {
                    scoresList.innerHTML = '<p style="text-align: center; color: #666;">Aucun score pour le moment</p>';
                } else {
                    data.forEach((score, index) => {
                        const div = document.createElement('div');
                        div.className = 'score-item';
                        if (index === 0) div.classList.add('gold');
                        if (index === 1) div.classList.add('silver');
                        if (index === 2) div.classList.add('bronze');

                        div.innerHTML = `
                            <div style="display: flex; align-items: center;">
                                <span class="rank">${index + 1}</span>
                                <div>
                                    <p style="font-weight: bold;">${score.player_name}</p>
                                    <p style="font-size: 14px; color: #666;">${score.game_name}</p>
                                </div>
                            </div>
                            <p style="font-size: 20px; font-weight: bold;">${score.time_seconds}s</p>
                        `;
                        scoresList.appendChild(div);
                    });
                }

                showScreen('leaderboardScreen');
            } catch (error) {
                console.error('Erreur chargement classement:', error);
            }
        }

        async function resetGame() {
            try {
                await supabaseClient.from('players')
                    .update({ status: 'waiting' })
                    .eq('id', playerId);

                currentPair = null;
                currentGame = null;
                playerFinished = false;
                opponentFinished = false;
                
                document.getElementById('playerBox').classList.remove('finished');
                document.getElementById('opponentBox').classList.remove('finished');
                document.getElementById('finishBtn').disabled = false;
                document.getElementById('finishBtn').textContent = '‚úì Fini !';
                document.getElementById('startGameBtn').disabled = false;
                document.getElementById('startGameBtn').textContent = '‚ñ∂Ô∏è Lancer un mini-jeu !';

                showScreen('waitingScreen');
                updateWaitingCount();
            } catch (error) {
                console.error('Erreur reset:', error);
            }
        }

        // Event listeners
        document.getElementById('loginBtn').addEventListener('click', handleLogin);
        document.getElementById('startGameBtn').addEventListener('click', startGame);
        document.getElementById('finishBtn').addEventListener('click', handleFinish);
        document.getElementById('replayBtn').addEventListener('click', resetGame);

        document.getElementById('playerNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        // ----------------------
// Fonctions Admin
// ----------------------

// Mettre √† jour le nombre de joueurs en attente pour admin
async function updateAdminWaitingCount() {
    try {
        const { count } = await supabaseClient
            .from('players')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'waiting');
        document.getElementById('adminWaitingCount').textContent = count || 0;
    } catch (error) {
        console.error('Erreur admin count:', error);
    }
}

// Afficher la liste des joueurs en attente pour l'admin
async function loadAdminPlayerList() {
    try {
        const { data } = await supabaseClient
            .from('players')
            .select('*')
            .eq('status', 'waiting');

        const list = document.getElementById('adminPlayerList');
        list.innerHTML = '';

        if (!data || data.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#666;">Aucun joueur en attente</p>';
            return;
        }

        data.forEach(player => {
            const div = document.createElement('div');
            div.className = 'player-box';
            div.innerHTML = `<p>${player.name}</p>`;
            list.appendChild(div);
        });
    } catch (error) {
        console.error('Erreur admin player list:', error);
    }
}
// ----------------------
// Event listener pour le bouton admin
document.getElementById('adminStartGameBtn').addEventListener('click', async () => {
    try {
        // R√©cup√©rer le premier joueur en attente
        const { data: availablePlayers } = await supabaseClient
            .from('players')
            .select('*')
            .eq('status', 'waiting')
            .limit(1);

        if (!availablePlayers || availablePlayers.length === 0) {
            alert('Aucun joueur en attente !');
            return;
        }

        // S√©lectionner ce joueur
        playerId = availablePlayers[0].id;
        playerName = availablePlayers[0].name;

        // Lancer le mini-jeu
        startGame();

        // Mettre √† jour la liste et le compteur pour l'admin
        updateAdminWaitingCount();
        loadAdminPlayerList();
    } catch (error) {
        console.error('Erreur lancement admin mini-jeu:', error);
    }
});

// Optionnel : actualiser automatiquement la liste des joueurs toutes les 5 secondes
setInterval(() => {
    if (!document.getElementById('adminScreen').classList.contains('hidden')) {
        updateAdminWaitingCount();
        loadAdminPlayerList();
    }
}, 5000);

    </script>
    <!-- √âcran Admin -->
<div id="adminScreen" class="container hidden">
    <h1>üéÆ Admin Panel</h1>
    <p class="subtitle">G√®re les mini-jeux et les appariements</p>

    <div class="info-box">
        <p><strong id="adminWaitingCount">0</strong> joueur(s) en attente</p>
    </div>

    <button class="btn-success" id="adminStartGameBtn">
        ‚ñ∂Ô∏è Lancer un mini-jeu pour un joueur
    </button>

    <div style="margin-top: 20px;">
        <h3>Liste des joueurs</h3>
        <div id="adminPlayerList" class="player-grid"></div>
    </div>
</div>

</body>
</html>


